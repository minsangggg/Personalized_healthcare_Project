# ===============================================
# ğŸ”¹ recipe_by_type.csv ë°ì´í„° ì „ì²˜ë¦¬ (ìš”êµ¬ì‚¬í•­ ì™„ë²½ ë°˜ì˜)
# ===============================================

import pandas as pd
import numpy as np
import re

# ---------------------------
# 1. CSV ë¶ˆëŸ¬ì˜¤ê¸°
# ---------------------------
df = pd.read_csv("recipe_by_type.csv")

# ---------------------------
# 2. í…ìŠ¤íŠ¸ ì •ë¦¬ í•¨ìˆ˜ ì •ì˜
# ---------------------------
def clean_text(text):
    if pd.isna(text):
        return text
    text = str(text)
    # ê¸´ ê³µë°± ì œê±°
    text = re.sub(r"\s+", " ", text)
    # ë¶ˆí•„ìš”í•œ íŠ¹ìˆ˜ë¬¸ì ì œê±° (~,~~,^^,\n,..,...,â™¥,+,_, ë“±)
    text = re.sub(r"[~\^â™¥\+\_]", "", text)
    text = text.replace("~~", "").replace("^^", "").replace("\n", "").replace("...", "").replace("..", "")
    return text.strip()

# ---------------------------
# 3. ê¸´ ê³µë°± / íŠ¹ìˆ˜ë¬¸ì ì „ì²˜ë¦¬ (ingredient_full, step_text, tag)
# ---------------------------
for col in ["ingredient_full", "step_text", "tag"]:
    if col in df.columns:
        df[col] = df[col].apply(clean_text)

# ---------------------------
# 4. servings ì±„ìš°ê¸° (cooking_time + step_text ê¸°ë°˜)
# ---------------------------
def infer_servings(row):
    if not pd.isna(row["servings"]):
        return row["servings"]

    step = str(row.get("step_text", "")).lower()
    cook_time = row.get("cooking_time", np.nan)

    # step_text ê¸°ë°˜ íŒ¨í„´
    if any(x in step for x in ["1ì¸ë¶„", "í˜¼ì", "í•œ ëª…", "í•œì‚¬ëŒ"]):
        return 1
    elif any(x in step for x in ["2ì¸ë¶„", "ë‘˜ì´", "2ëª…", "ë‘ ëª…"]):
        return 2
    elif any(x in step for x in ["3ì¸ë¶„", "ì…‹ì´", "3ëª…"]):
        return 3
    elif any(x in step for x in ["4ì¸ë¶„", "4ëª…", "ê°€ì¡±", "ì—¬ëŸ¿"]):
        return 4
    # cooking_time ê¸°ì¤€ ì¶”ë¡ 
    elif pd.notna(cook_time):
        if cook_time <= 15:
            return 1
        elif cook_time <= 30:
            return 2
        elif cook_time <= 60:
            return 3
        else:
            return 4
    return np.nan

df["servings"] = df.apply(infer_servings, axis=1)

# ---------------------------
# 5. cooking_time ì±„ìš°ê¸° (servings + step_text ê¸°ë°˜)
# ---------------------------
def infer_cooking_time(row):
    if not pd.isna(row["cooking_time"]):
        return row["cooking_time"]

    step = str(row.get("step_text", "")).lower()
    serv = row.get("servings", np.nan)

    # step_text ë‚´ ì‹œê°„ ë‹¨ì„œ ì¶”ì¶œ
    match = re.search(r"(\d+)\s*(ë¶„|ì‹œê°„)", step)
    if match:
        val = int(match.group(1))
        if "ì‹œê°„" in match.group(2):
            return val * 60
        else:
            return val

    # servings ê¸°ë°˜ ì¶”ë¡ 
    if not pd.isna(serv):
        if serv <= 1:
            return 15
        elif serv <= 2:
            return 30
        elif serv <= 4:
            return 45
        else:
            return 60
    return np.nan

df["cooking_time"] = df.apply(infer_cooking_time, axis=1)

# ---------------------------
# 6. level_nm ë³€í™˜ (ê·œì¹™ ì™„ì „ ë°˜ì˜)
# ---------------------------
def map_level(row):
    level = str(row.get("level_nm", "")).strip()
    cook_time = row.get("cooking_time", np.nan)
    serv = row.get("servings", np.nan)

    # ê¸°ì¡´ ë§¤í•‘
    if level == "ì´ˆê¸‰":
        return "í•˜"
    elif level == "ì¤‘ê¸‰":
        return "ìƒ"
    elif level == "ì•„ë¬´ë‚˜":
        if pd.notna(cook_time):
            return "ìƒ" if cook_time >= 30 else "í•˜"
        else:
            return "í•˜"

    # ê²°ì¸¡ì¹˜ ì²˜ë¦¬
    if level in ["", "nan", "None"] or pd.isna(level):
        if pd.notna(serv) and serv >= 5:
            return "ìƒ"
        else:
            return "í•˜"

    return level

df["level_nm"] = df.apply(map_level, axis=1)

# ---------------------------
# 7. ì¸ë±ìŠ¤ ì¬ì •ë ¬ (ì¤‘ê°„ ë¹ˆí–‰ ì œê±°)
# ---------------------------
df.dropna(how="all", inplace=True)
df.reset_index(drop=True, inplace=True)

# ---------------------------
# 8. ì €ì¥
# ---------------------------
output_path = "recipe_by_type_cleaned.csv"
df.to_csv(output_path, index=False, encoding="utf-8-sig")

print(f"âœ… ì „ì²˜ë¦¬ ì™„ë£Œ! ì €ì¥ëœ íŒŒì¼: {output_path}")
