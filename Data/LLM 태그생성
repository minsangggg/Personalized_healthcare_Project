# ===============================================
# ğŸ”¹ recipe_by_type_cleaned.csvì˜ tag ê²°ì¸¡ì¹˜ ë° [] ê°’ ì±„ìš°ê¸° (LLM ìë™ ë³´ì™„)
# ===============================================

import os
import pandas as pd
from openai import OpenAI
from dotenv import load_dotenv
from tqdm import tqdm

# ---------------------------
# 1. í™˜ê²½ì„¤ì • ë° API ì´ˆê¸°í™”
# ---------------------------
load_dotenv()
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# ---------------------------
# 2. CSV íŒŒì¼ ë¡œë“œ
# ---------------------------
file_path = "recipe_by_type_cleaned.csv"  # íŒŒì¼ ê²½ë¡œ ìˆ˜ì • ê°€ëŠ¥
df = pd.read_csv(file_path)

# ---------------------------
# 3. ê²°ì¸¡ì¹˜ + [] í˜•íƒœ ëª¨ë‘ íƒì§€
# ---------------------------
if "tag" not in df.columns:
    raise ValueError(" 'tag' ì»¬ëŸ¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")

def is_missing_tag(val):
    """ë¹ˆ íƒœê·¸ íŒë³„ (NaN, ë¹ˆ ë¬¸ìì—´, [], [''], ê³µë°± ë“± ëª¨ë‘ í¬í•¨)"""
    if pd.isna(val):
        return True
    s = str(val).strip()
    return s in ["", "[]", "['']", "['nan']", "nan", "None"]

missing_tags = df[df["tag"].apply(is_missing_tag)].copy()

print(f" íƒœê·¸ ê²°ì¸¡ì¹˜ ê°œìˆ˜: {len(missing_tags)}")

# ---------------------------
# 4. LLM í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ì •ì˜
# ---------------------------
def generate_prompt(row):
    """ë ˆì‹œí”¼ ê¸°ë°˜ íƒœê·¸ ìƒì„±ìš© í”„ë¡¬í”„íŠ¸ (ì •í™• ë²„ì „)"""
    recipe_nm_ko = str(row.get("recipe_nm_ko", "")).strip()
    ingredient_full = str(row.get("ingredient_full", "")).strip()
    step_text = str(row.get("step_text", "")).strip()

    if not any([recipe_nm_ko, ingredient_full, step_text]):
        return "ì´ ë ˆì‹œí”¼ì—ëŠ” ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. íƒœê·¸ë¥¼ ìƒì„±í•˜ì§€ ë§ˆì„¸ìš”."

    return f"""
ë‹¹ì‹ ì€ í•œì‹Â·ì–‘ì‹Â·ì¤‘ì‹ ë“± ëª¨ë“  ìš”ë¦¬ì— ì •í†µí•œ **ìš”ë¦¬ ë°ì´í„° ì „ë¬¸ê°€**ì´ì,
ìš”ë¦¬ ì½˜í…ì¸  ë¶„ë¥˜ë¥¼ ìœ„í•œ **ML í•™ìŠµ ë°ì´í„° íƒœê·¸ëŸ¬**ì…ë‹ˆë‹¤.

ì§€ê¸ˆë¶€í„° ì£¼ì–´ì§€ëŠ” ë ˆì‹œí”¼ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ, ì´ ìš”ë¦¬ì˜ **í•µì‹¬ íŠ¹ì§•ì„ ì„¤ëª…í•˜ëŠ” í•´ì‹œíƒœê·¸**ë¥¼ ë§Œë“¤ì–´ ì£¼ì„¸ìš”.

ğŸ“˜ ë ˆì‹œí”¼ ì •ë³´:
- [ìš”ë¦¬ ì´ë¦„] {recipe_nm_ko}
- [ì¬ë£Œ ëª©ë¡] {ingredient_full}
- [ì¡°ë¦¬ ë‹¨ê³„ ìš”ì•½] {step_text}

ğŸ¯ íƒœê·¸ ìƒì„± ê·œì¹™:
1. ìŒì‹ì˜ **ì£¼ì¬ë£Œ, ì¡°ë¦¬ë²•, ë§›ì˜ íŠ¹ì§•, ìŒì‹ ì¢…ë¥˜, ì‹ì‚¬ ì‹œê°„ëŒ€, ë‚˜ë¼/ì§€ì—­**ì„ ë°˜ì˜í•˜ì„¸ìš”.
   (ì˜ˆ: #ë‹­ìš”ë¦¬ #í•œì‹ #ë§¤ìš´ë§› #ì¡°ë¦¼ìš”ë¦¬ #ì €ë…ë°˜ì°¬)
2. íƒœê·¸ëŠ” ë°˜ë“œì‹œ **3ê°œ ì´ìƒ 7ê°œ ì´í•˜**ë¡œ ìƒì„±í•˜ì„¸ìš”.
3. **'#'ì„ í¬í•¨í•œ í•œ ì¤„ ë¬¸ìì—´**ë¡œë§Œ ì¶œë ¥í•˜ì„¸ìš”. (ì˜ˆ: `#ë‹­ë³¶ìŒíƒ• #í•œì‹ #ë§¤ìš´ìŒì‹ #ì¡°ë¦¼ #ì§‘ë°¥`)
4. ë¶ˆí•„ìš”í•œ ì„¤ëª…, ë¬¸ì¥, ì´ëª¨í‹°ì½˜ ë“±ì€ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.
5. ìš”ë¦¬ ì´ë¦„ì´ â€œë‹­â€, â€œê°ìâ€, â€œë‘ë¶€â€, â€œì—°ë‘ë¶€â€, â€œê³ ë“±ì–´â€, â€œê¹€ì¹˜â€, â€œëœì¥â€ ë“±ì„ í¬í•¨í•˜ë©´, í•´ë‹¹ ì¬ë£Œ ê´€ë ¨ íƒœê·¸ë¥¼ ë°˜ë“œì‹œ í¬í•¨í•˜ì„¸ìš”.
6. ì¡°ë¦¬ ê³¼ì •ì— 'ë³¶ë‹¤', 'ë“ì´ë‹¤', 'ì¡°ë¦¬ë‹¤', 'êµ½ë‹¤', 'íŠ€ê¸°ë‹¤' ë“±ì˜ ë‹¨ì–´ê°€ ìˆìœ¼ë©´, í•´ë‹¹ ì¡°ë¦¬ë²• íƒœê·¸ë¥¼ ë°˜ë“œì‹œ ì¶”ê°€í•˜ì„¸ìš”.
7. ë ˆì‹œí”¼ ì„¤ëª…ì´ ë¶€ì¡±í•˜ë©´ ì¼ë°˜ì ì¸ ì¶”ë¡ ìœ¼ë¡œ ë³´ì™„í•˜ì„¸ìš”.
   (ì˜ˆ: 'ê³ ì¶”ì¥'ì´ ìˆìœ¼ë©´ #ë§¤ìš´ë§›, 'ì—°ë‘ë¶€'ê°€ ìˆìœ¼ë©´ #ë¶€ë“œëŸ¬ìš´ì‹ê°, 'ê³„ë€'ì´ ìˆìœ¼ë©´ #ë‹¨ë°±ì§ˆìŒì‹)
8. í•œêµ­ì–´ë¡œë§Œ íƒœê·¸ë¥¼ ìƒì„±í•˜ì„¸ìš”. ì˜ì–´ëŠ” í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.

âš ï¸ ì¶œë ¥ ì˜ˆì‹œ:
- ì…ë ¥: ë‹­ë³¶ìŒíƒ•, ì¬ë£Œ=ë‹­, ê³ ì¶”ì¥, ê°ì / ë‹¨ê³„=ë“ì¸ë‹¤, ì¡¸ì¸ë‹¤
- ì¶œë ¥: #ë‹­ë³¶ìŒíƒ• #í•œì‹ #ë‹­ìš”ë¦¬ #ë§¤ìš´ìŒì‹ #ì¡°ë¦¼ìš”ë¦¬ #ì§‘ë°¥

- ì…ë ¥: ì—°ë‘ë¶€ë‹¬ê±€íƒ•, ì¬ë£Œ=ì—°ë‘ë¶€, ë‹¬ê±€ / ë‹¨ê³„=ë“ì¸ë‹¤
- ì¶œë ¥: #ì—°ë‘ë¶€ë‹¬ê±€íƒ• #í•œì‹ #ë¶€ë“œëŸ¬ìš´ì‹ê° #ê°„í¸ìš”ë¦¬ #ë‘ë¶€ìš”ë¦¬ #êµ­ë¬¼ìš”ë¦¬

ì´ì œ ìœ„ ê·œì¹™ì— ë”°ë¼ íƒœê·¸ë¥¼ ìƒì„±í•˜ì„¸ìš”.
"""

# ---------------------------
# 5. LLMìœ¼ë¡œ íƒœê·¸ ìë™ ìƒì„±
# ---------------------------
generated_tags = []
for _, row in tqdm(missing_tags.iterrows(), total=len(missing_tags), desc="ğŸ§  LLM íƒœê·¸ ìƒì„± ì¤‘"):
    try:
        prompt = generate_prompt(row)
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": "ë‹¹ì‹ ì€ ìš”ë¦¬ ë°ì´í„° ë¶„ì„ ì „ë¬¸ê°€ì´ë©°, ë ˆì‹œí”¼ ë°ì´í„°ë¥¼ êµ¬ì¡°í™”í•©ë‹ˆë‹¤."},
                {"role": "user", "content": prompt},
            ],
            temperature=0.3,
        )
        tag_text = response.choices[0].message.content.strip()
        print(f" [{row.name}] íƒœê·¸ ìƒì„± ì™„ë£Œ: {tag_text}")
        generated_tags.append(tag_text)
    except Exception as e:
        print(f" ì˜¤ë¥˜ ë°œìƒ (index={row.name}): {e}")
        generated_tags.append("")

missing_tags["tag"] = generated_tags

# ---------------------------
# 6. ì›ë³¸ dfì— ë°˜ì˜
# ---------------------------
df.loc[missing_tags.index, "tag"] = missing_tags["tag"]

# ---------------------------
# 7. ì¸ë±ìŠ¤ ì¬ì •ë ¬ + ì €ì¥
# ---------------------------
df.reset_index(drop=True, inplace=True)
output_path = "recipe_by_type_tag_filled.csv"
df.to_csv(output_path, index=False, encoding="utf-8-sig")
print(f" ì™„ë£Œ! íƒœê·¸ê°€ ì±„ì›Œì§„ íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤: {output_path}")
